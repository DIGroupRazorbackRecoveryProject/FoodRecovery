<!-- templates/pickuprequestdetails.html -->
<h1 class="title">Request Details</h1>

<div class="summary-item">
  <img src="/FoodRecovery/icons/event.png" alt="Event Icon">
  <div>
      <h3>Event Name</h3>
      <p id="event-name">Loading...</p>
  </div>
</div>

<div class="summary-item">
  <img src="/FoodRecovery/icons/requesttype.png" alt="Request Type Icon">
  <div>
      <h3>Request Type</h3>
      <p id="request-type">Loading...</p>
  </div>
</div>

<div class="summary-item">
  <img src="/FoodRecovery/icons/location.png" alt="Location Icon">
  <div>
      <h3>Location</h3>
      <p id="location">Loading...</p>
  </div>
</div>

<div class="summary-item">
  <img src="path/to/your/map.png" alt="Map" style="width: 100%; height: auto;">
</div>

<div class="summary-item">
  <img src="/FoodRecovery/icons/food.png" alt="Food Type Icon">
  <div>
      <h3>Food</h3>
      <p id="food">Loading...</p>
  </div>
</div>

<div class="summary-item">
  <img src="/FoodRecovery/icons/quantity.png" alt="Quantity Icon">
  <div>
      <h3>Quantity</h3>
      <p id="quantity">Loading...</p>
  </div>
</div>

<div class="summary-item">
  <img src="/FoodRecovery/icons/notes.png" alt="Notes Icon">
  <div>
      <h3>Notes</h3>
      <p id="notes">Loading...</p>
  </div>
</div>

<button class="btn btn-primary" id="accept-request-button">Accept Request</button>

<script type="module">
    import { getFirestore, doc, updateDoc, addDoc, collection } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const app = getApp();
    const db = getFirestore(app);
    const auth = getAuth();

    $(document).ready(function() {
      if (localStorage.getItem('latestRequest')) {
        const latestRequest = JSON.parse(localStorage.getItem('latestRequest'));
        $('#event-name').text(latestRequest.eventName || 'N/A');
        $('#request-type').text(latestRequest.requestType || 'N/A');
        $('#location').text(latestRequest.location || 'N/A');
        $('#food').text(latestRequest.food || 'N/A');
        $('#quantity').text(latestRequest.quantity ? latestRequest.quantity + ' lbs' : 'N/A');
        $('#notes').text(latestRequest.notes || 'N/A');
      } else {
        console.error('No valid request details found. Please select a request.');
        alert('No valid request details found. Please select a request.');
      }

      $('#accept-request-button').click(async function() {
        if (localStorage.getItem('latestRequest')) {
          const latestRequest = JSON.parse(localStorage.getItem('latestRequest'));
          const requestNumber = generateRequestNumber();

          console.log('Attempting to accept request:', latestRequest);
          console.log('Generated request number:', requestNumber);

          try {
            // Update the request status in hostRequests collection
            if (latestRequest.hostRequestid) {  // Changed from id to hostRequestid
              const requestDocRef = doc(db, "hostRequests", latestRequest.hostRequestid);
              await updateDoc(requestDocRef, {
                status: "accepted"
              });

              // Get the current user
              const currentUser = auth.currentUser;
              if (!currentUser) {
                throw new Error('No user is currently logged in');
              }

              // Add to acceptedRequests collection with volunteerId
              await addDoc(collection(db, "acceptedRequests"), {
                requestNumber,
                hostRequestid: latestRequest.hostRequestid,  // Store the reference to hostRequests
                volunteerId: currentUser.uid,
                eventName: latestRequest.eventName,
                requestType: latestRequest.requestType,
                location: latestRequest.location,
                food: latestRequest.food,
                quantity: latestRequest.quantity,
                notes: latestRequest.notes,
                acceptedAt: new Date().toISOString(),
                completedAt: null,
                status: 'accepted'
              });

              console.log('Request accepted and saved successfully.');
              alert(`Request accepted! Request Number: ${requestNumber}`);
              loadContent('acceptedrequest');
            } else {
              console.error('No document ID found for the request.');
            }
          } catch (error) {
            console.error('Error saving accepted request:', error);
            alert('Error saving request.');
          }
        } else {
          alert('No valid request details found. Please select a request.');
        }
      });
    });

    function generateRequestNumber() {
      return Math.floor(100000 + Math.random() * 900000); // Generate a random 6-digit number
    }
</script>
